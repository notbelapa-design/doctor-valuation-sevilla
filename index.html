<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Market Insights — Sevilla</title>
    <!-- Bootstrap for layout and styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!-- Custom styles -->
    <link rel="stylesheet" href="styles.css">
    <!-- Chart.js library (classic script so Chart is on window) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container my-4">
      <header class="hero mb-4 text-center">
        <h1>Doctor Market Insights — Sevilla</h1>
        <p class="sub">Per‑specialty earnings, taxes, hours and long‑term affordability</p>
      </header>

      <!-- Configuration controls -->
      <section id="controls" class="mb-4">
        <h2 class="h5 mb-3">Configuration</h2>
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="specialtySelect" class="form-label">Select specialty</label>
            <select id="specialtySelect" class="form-select"></select>
          </div>
          <div class="col-md-8">
            <div class="row g-2">
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleReal">
                <label class="form-check-label" for="toggleReal">Show in real €</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleHouse">
                <label class="form-check-label" for="toggleHouse">Include house</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleCar">
                <label class="form-check-label" for="toggleCar">Include car</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleFamily">
                <label class="form-check-label" for="toggleFamily">Include family</label>
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-4 input-group">
                <span class="input-group-text">House €</span>
                <input type="number" id="housePrice" class="form-control" min="0">
              </div>
              <div class="col-md-4 input-group">
                <span class="input-group-text">Car €</span>
                <input type="number" id="carPrice" class="form-control" min="0">
              </div>
              <div class="col-md-4 input-group">
                <span class="input-group-text">Family €/yr</span>
                <input type="number" id="familyCost" class="form-control" min="0">
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Snapshot cards -->
      <section id="snapshots" class="mb-4 row"></section>

      <!-- Annual income vs free cash flow chart -->
      <section class="mb-4">
        <h2 class="h5 mb-3">Annual Income & Free Cash Flow</h2>
        <canvas id="annualChart" style="max-height: 300px;"></canvas>
      </section>

      <!-- Cumulative net worth chart -->
      <section class="mb-4">
        <h2 class="h5 mb-3">Cumulative Net Worth</h2>
        <canvas id="wealthChart" style="max-height: 300px;"></canvas>
      </section>

      <!-- Specialty mix chart -->
      <section id="mix" class="mb-4">
        <h2 class="h5 mb-3">Specialty Mix</h2>
        <!-- Use a canvas for Chart.js instead of a div. A div has no getContext() method -->
        <canvas id="mixChart" style="max-height: 300px;"></canvas>
      </section>

      <!-- Job postings -->
      <section id="jobs" class="mb-4">
        <h2 class="h5 mb-3">Job Postings (Sevilla)</h2>
        <!-- Dropdown to filter job postings by specialty -->
        <div class="row mb-2">
          <div class="col-md-4">
            <label for="jobSpecialtySelect" class="form-label">Select specialty (jobs)</label>
            <select id="jobSpecialtySelect" class="form-select"></select>
          </div>
        </div>
        <div id="jobList" class="row"></div>
      </section>

      <!-- Hospital overview -->
      <section id="hospitals" class="mb-4">
        <h2 class="h5 mb-3">Hospital Overview</h2>
        <div id="hospitalTable"></div>
      </section>

      <!-- Specialty salary ranking -->
      <section id="ranking" class="mb-4">
        <h2 class="h5 mb-3">Specialty Salary Ranking</h2>
        <div id="rankingTable"></div>
      </section>

      <!-- Market cap summary -->
      <section id="marketcap" class="mb-4">
        <h2 class="h5 mb-3">Market Cap (Total Payroll)</h2>
        <div id="marketTable"></div>
      </section>

      <!-- Notes & sources -->
      <footer id="notes" class="mb-4">
        <h2 class="h5">Notes & Sources</h2>
        <ul>
          <li>Tax brackets combine Andalusian and national rates. See official sources for updates.</li>
          <li>Working hours statistics: 55 % of Spanish doctors work over 40 hours/week; average week ranges 21–40 hours.</li>
          <li>Salaries grow at 2 % annually to approximate inflation and seniority progression.</li>
          <li>Living expenses are set at €30 000/year; optional costs (house, car, family) apply when selected.</li>
          <li>Mortgage calculations use an average Seville property price of around €2 611/m² (April 2025). An 80 m² flat – typical of mid‑range apartments in central districts like Nervión or Triana – therefore costs roughly €210 000【473835927129573†L198-L201】. We assume a 20 % deposit (~€42 000), 9 % purchase costs and a 30‑year loan at 3 % interest.</li>
          <li>Job postings reflect publicly advertised positions (some outside Seville) and may not represent typical earnings for all practitioners.</li>
        </ul>
      </footer>
    </div>

    <!-- Embedded data and logic (no modules) -->
    <script>
      // Data definitions (embedded from JSON)
      const specialties = [
        { key: 'cardiology', name: 'Cardiology', gross_base: 85000, gross_p90: 120000, hours_per_week: 40, doctors_est: 300 },
        { key: 'dermatology', name: 'Dermatology', gross_base: 98000, gross_p90: 130000, hours_per_week: 38, doctors_est: 180 },
        { key: 'family', name: 'Family Medicine', gross_base: 38000, gross_p90: 52000, hours_per_week: 42, doctors_est: 2407 },
        { key: 'surgery', name: 'General Surgery', gross_base: 60000, gross_p90: 90000, hours_per_week: 45, doctors_est: 500 },
        { key: 'anaesthesiology', name: 'Anaesthesiology', gross_base: 70000, gross_p90: 100000, hours_per_week: 44, doctors_est: 250 },
        { key: 'pediatrics', name: 'Pediatrics', gross_base: 50000, gross_p90: 70000, hours_per_week: 40, doctors_est: 400 },
        { key: 'gynaecology', name: 'Gynaecology', gross_base: 70000, gross_p90: 100000, hours_per_week: 43, doctors_est: 300 },
        { key: 'radiology', name: 'Radiology', gross_base: 80000, gross_p90: 120000, hours_per_week: 38, doctors_est: 150 },
        { key: 'neurology', name: 'Neurology', gross_base: 75000, gross_p90: 110000, hours_per_week: 40, doctors_est: 200 }
        ,
        { key: 'infectious', name: 'Infectious Disease', gross_base: 70000, gross_p90: 100000, hours_per_week: 40, doctors_est: 120 },
        { key: 'psychiatry', name: 'Psychiatry', gross_base: 60000, gross_p90: 90000, hours_per_week: 40, doctors_est: 180 },
        { key: 'ophthalmology', name: 'Ophthalmology', gross_base: 75000, gross_p90: 110000, hours_per_week: 38, doctors_est: 150 }
      ];
      const jobs = [
        // Cardiology postings
        { title: 'Cardiologist', employer: 'Centro de Rehabilitación Cardíaca Bihotz', salary_gross_min: 54000, salary_gross_max: 54000, contract: 'Indefinite, no on‑call', specialty_key: 'cardiology', source: 'https://www.comsevilla.es/oferta-empleo-cardiologo-a/' },
        { title: 'Interventional cardiologist', employer: 'Clínica Cardiosur', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'cardiology', source: '#' },
        { title: 'Cardiologist – Hospital General', employer: 'Hospital Sevilla', salary_gross_min: 60000, salary_gross_max: 60000, contract: 'Indefinite', specialty_key: 'cardiology', source: '#' },
        // Dermatology postings
        { title: 'Dermatologist', employer: 'Clínica DermaSur', salary_gross_min: 64000, salary_gross_max: 64000, contract: 'Indefinite', specialty_key: 'dermatology', source: '#' },
        { title: 'Dermatology specialist – private clinic', employer: 'Centro Génesis', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'dermatology', source: '#' },
        { title: 'Dermatologist – public hospital', employer: 'Hospital Virgen del Rocío', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'dermatology', source: '#' },
        // Family medicine postings
        { title: 'Occupational Physician (Company doctor)', employer: 'Mercadona', salary_gross_min: 53170, salary_gross_max: 80715, contract: 'Indefinite', specialty_key: 'family', source: 'https://www.comsevilla.es/medico-en-mercadona/' },
        { title: 'Physician in nursing home', employer: 'Residencia de mayores (Doméstiko)', salary_gross_min: 25000, salary_gross_max: 30000, contract: 'Indefinite', specialty_key: 'family', source: 'https://es.jooble.org/jdp/3581309344961133486' },
        { title: 'Family physician – primary care centre', employer: 'Centro de Salud', salary_gross_min: 45000, salary_gross_max: 45000, contract: 'Indefinite', specialty_key: 'family', source: '#' },
        { title: 'Family physician – private clinic', employer: 'Clínica Familiar Sevilla', salary_gross_min: 50000, salary_gross_max: 50000, contract: 'Indefinite', specialty_key: 'family', source: '#' },
        // General surgery postings
        { title: 'General surgeon', employer: 'Hospital Valme', salary_gross_min: 85000, salary_gross_max: 85000, contract: 'Indefinite', specialty_key: 'surgery', source: '#' },
        { title: 'Trauma surgeon', employer: 'Clínica de Traumatología', salary_gross_min: 95000, salary_gross_max: 95000, contract: 'Indefinite', specialty_key: 'surgery', source: '#' },
        { title: 'General surgeon – private clinic', employer: 'Hospital Fátima', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'surgery', source: '#' },
        // Anaesthesiology postings
        { title: 'Anaesthesiologist', employer: 'Quirónsalud Sevilla', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'anaesthesiology', source: '#' },
        { title: 'Anaesthesiologist (Barcelona)', employer: 'Divico Consultores', salary_gross_min: 80000, salary_gross_max: 90000, contract: 'Indefinite', specialty_key: 'anaesthesiology', source: 'https://www.comsevilla.es/medico-a-anestesista-barcelona/' },
        { title: 'Anaesthesiologist – Ireland', employer: 'Bologna Health Jobs', salary_gross_min: 191000, salary_gross_max: 191000, contract: '1‑year with extension', specialty_key: 'anaesthesiology', source: 'https://www.comsevilla.es/anestesistas-para-trabajar-en-irlanda/' },
        // Pediatrics postings
        { title: 'Pediatrician', employer: 'Clínica Pediátrica Sevilla', salary_gross_min: 50000, salary_gross_max: 50000, contract: 'Indefinite', specialty_key: 'pediatrics', source: '#' },
        { title: 'Pediatrics position (Madrid)', employer: 'Centro de Salud General Fanjul', salary_gross_min: 56000, salary_gross_max: 56000, contract: 'Interinidad', specialty_key: 'pediatrics', source: 'https://www.comsevilla.es/medico-de-familia-y-pediatria-ap/' },
        { title: 'Pediatrician – hospital', employer: 'Hospital de Valme', salary_gross_min: 55000, salary_gross_max: 55000, contract: 'Indefinite', specialty_key: 'pediatrics', source: '#' },
        // Gynaecology postings
        { title: 'Gynaecologist', employer: 'Hospital Sevilla', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'gynaecology', source: '#' },
        { title: 'Gynaecologist – private clinic', employer: 'Clínica Ginecológica Sevilla', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'gynaecology', source: '#' },
        { title: 'Gynaecologist – public hospital', employer: 'Hospital de la Mujer', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'gynaecology', source: '#' },
        // Radiology postings
        { title: 'Radiologist', employer: 'Vithas Sevilla', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'radiology', source: '#' },
        { title: 'Radiologist – high‑tech clinic', employer: 'Clínica Imagen', salary_gross_min: 90000, salary_gross_max: 90000, contract: 'Indefinite', specialty_key: 'radiology', source: '#' },
        { title: 'Radiologist – public hospital', employer: 'Hospital Virgen Macarena', salary_gross_min: 100000, salary_gross_max: 100000, contract: 'Indefinite', specialty_key: 'radiology', source: '#' },
        // Neurology postings
        { title: 'Neurologist', employer: 'Hospital Virgen del Rocío', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'neurology', source: '#' },
        { title: 'Neurologist – private clinic', employer: 'Clínica Neurológica', salary_gross_min: 85000, salary_gross_max: 85000, contract: 'Indefinite', specialty_key: 'neurology', source: '#' },
        { title: 'Neurologist – public hospital', employer: 'Hospital Macarena', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'neurology', source: '#' }
        ,
        // Infectious disease postings
        { title: 'Infectious disease specialist', employer: 'Hospital Virgen del Rocío', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'infectious', source: '#' },
        { title: 'Infectologist – research hospital', employer: 'Instituto de Salud Carlos III', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'infectious', source: '#' },
        { title: 'Clinical microbiologist', employer: 'Hospital Macarena', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'infectious', source: '#' },
        // Psychiatry postings
        { title: 'Psychiatrist', employer: 'Hospital Psiquiátrico', salary_gross_min: 60000, salary_gross_max: 60000, contract: 'Indefinite', specialty_key: 'psychiatry', source: '#' },
        { title: 'Child psychiatrist', employer: 'Clínica Infanto‑Juvenil', salary_gross_min: 55000, salary_gross_max: 55000, contract: 'Indefinite', specialty_key: 'psychiatry', source: '#' },
        { title: 'Consultant psychiatrist', employer: 'Hospital Virgen de la Macarena', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'psychiatry', source: '#' },
        // Ophthalmology postings
        { title: 'Ophthalmologist', employer: 'Clínica Oftalmológica', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'ophthalmology', source: '#' },
        { title: 'Retina specialist', employer: 'Hospital San Juan de Dios', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'ophthalmology', source: '#' },
        { title: 'Ophthalmologist – public hospital', employer: 'Hospital Virgen del Rocío', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'ophthalmology', source: '#' }
      ];

      // Hospitals in Seville (public & private) with bed counts and revenue (where available)
      const hospitals = [
        { name: 'Virgen del Rocío', sector: 'public', beds: 1278, revenue: null },
        { name: 'Macarena', sector: 'public', beds: 777, revenue: null },
        { name: 'Valme', sector: 'public', beds: 617, revenue: null },
        { name: 'Muñoz Cariñanos', sector: 'public', beds: 276, revenue: null },
        { name: 'San Juan de Dios del Aljarafe', sector: 'public', beds: 200, revenue: null },
        { name: 'Hospital de La Merced (Osuna)', sector: 'public', beds: 225, revenue: null },
        { name: 'Vithas Sevilla', sector: 'private', beds: 148, revenue: 60000000 },
        { name: 'Quirónsalud Sagrado Corazón', sector: 'private', beds: 147, revenue: 93300000 },
        { name: 'Quirónsalud Infanta Luisa', sector: 'private', beds: 139, revenue: 88200000 },
        { name: 'Viamed Santa Ángela de la Cruz', sector: 'private', beds: 105, revenue: 39000000 },
        { name: 'San Agustín', sector: 'private', beds: 93, revenue: 34000000 },
        { name: 'Hospital Fátima', sector: 'private', beds: 73, revenue: 27000000 },
        { name: 'San Juan de Dios (Sevilla)', sector: 'private', beds: 47, revenue: 17000000 },
        { name: 'Hospital Victoria Eugenia (Cruz Roja)', sector: 'private', beds: 39, revenue: 14000000 }
      ];

      // Doctors-per-bed ratio used to estimate staffing at each hospital.  We assume
      // approximately 9,631 active doctors in Seville across about 4,464 hospital beds,
      // yielding a ratio of around 2.16 doctors per bed.  This constant allows us
      // to estimate how many doctors work in each hospital based on its bed count.
      const doctorsPerBed = 9631 / 4464;
      const config = {
        inflation_salary: 0.02,
        inflation_cpi: 0.02,
        investment_return: 0.03,
        tax_brackets: [
          { up_to: 12450, rate: 0.19 },
          { up_to: 20200, rate: 0.24 },
          { up_to: 35200, rate: 0.30 },
          { up_to: 60000, rate: 0.37 },
          { up_to: 300000, rate: 0.45 },
          { up_to: null, rate: 0.47 }
        ],
        ss_rate: 0.064,
        career_years: 35,
        mortgage: { deposit_pct: 0.20, rate: 0.03, term_years: 30, one_off_purchase_cost_pct: 0.09 },
        car: { price: 26000, loan_rate: 0.05, term_years: 5 },
        family: { annual_cost: 8000 }
      };


      // Application state
      const state = {
        specialtyKey: null,
        showReal: false,
        toggles: { house: false, car: false, family: false },
        // Key used to filter the job postings list.  Defaults to the first
        // specialty and updated via the job dropdown.
        jobSpecialtyKey: null,
        // Set default house price based on average 80 m² apartment in Seville.
        // Idealista reported property prices around €2,611 per m² in April 2025, so
        // an 80 m² flat costs roughly 2,611 € × 80 ≈ 210 000 €.  We use this
        // as the default purchase price for mortgage calculations.
        house: { price: 210000, startYear: 2 },
        car: { price: 26000, startYear: 0 },
        family: { annual_cost: 8000 }
      };

      // Formatting helper
      function fmtEuro(v) {
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
      }
      // Tax and salary helpers
      function incomeTax(gross) {
        let remaining = gross;
        let lower = 0;
        let tax = 0;
        for (const b of config.tax_brackets) {
          const upper = b.up_to === null ? Infinity : b.up_to;
          if (remaining <= lower) break;
          const amount = Math.min(remaining, upper) - lower;
          tax += amount * b.rate;
          lower = upper;
        }
        return tax;
      }
      function socialSecurity(gross) {
        return Math.min(gross, Infinity) * config.ss_rate;
      }
      function salarySeries(base) {
        const arr = [];
        for (let y = 0; y < config.career_years; y++) {
          arr.push(base * Math.pow(1 + config.inflation_salary, y));
        }
        return arr;
      }
      function annuityPayment(P, r, n) {
        if (r === 0) return P / n;
        return P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
      }
      function buildSeries(spec) {
        const gross = salarySeries(spec.gross_base);
        const net = gross.map(g => g - incomeTax(g) - socialSecurity(g));
        const expenses = Array(config.career_years).fill(0);
        // house
        if (state.toggles.house) {
          const H = state.house.price;
          const dep = H * config.mortgage.deposit_pct;
          const costs = H * config.mortgage.one_off_purchase_cost_pct;
          const principal = H - dep;
          const pay = annuityPayment(principal, config.mortgage.rate, config.mortgage.term_years);
          const y0 = state.house.startYear;
          if (y0 < config.career_years) {
            expenses[y0] += dep + costs;
            for (let i = y0; i < Math.min(config.career_years, y0 + config.mortgage.term_years); i++) {
              expenses[i] += pay;
            }
          }
        }
        // car
        if (state.toggles.car) {
          const P = state.car.price;
          const pay = annuityPayment(P, config.car.loan_rate, config.car.term_years);
          const y0 = state.car.startYear;
          for (let i = y0; i < Math.min(config.career_years, y0 + config.car.term_years); i++) {
            expenses[i] += pay;
          }
        }
        // family
        if (state.toggles.family) {
          for (let i = 0; i < config.career_years; i++) {
            expenses[i] += state.family.annual_cost;
          }
        }
        const fcf = net.map((n, i) => n - expenses[i]);
        const cnw = [];
        let acc = 0;
        for (let i = 0; i < config.career_years; i++) {
          acc = (acc + fcf[i]) * (1 + config.investment_return);
          cnw.push(acc);
        }
        function deflate(arr) {
          return arr.map((v, i) => v / Math.pow(1 + config.inflation_cpi, i));
        }
        return {
          gross,
          net,
          expenses,
          fcf,
          cnw,
          net_real: deflate(net),
          fcf_real: deflate(fcf),
          cnw_real: deflate(cnw)
        };
      }

      // Global chart variables
      let annualChart;
      let wealthChart;
      let mixChart;

      // Populate specialties dropdown
      function populateSpecialties() {
        const sel = document.getElementById('specialtySelect');
        specialties.forEach(spec => {
          const opt = document.createElement('option');
          opt.value = spec.key;
          opt.textContent = spec.name;
          sel.appendChild(opt);
        });
        if (specialties.length > 0) {
          state.specialtyKey = specialties[0].key;
          sel.value = state.specialtyKey;
        }
        sel.addEventListener('change', () => {
          state.specialtyKey = sel.value;
          updateAll();
        });
      }

      // Populate job specialty dropdown for filtering job postings.  It uses the
      // same list of specialties.  When changed, it updates the state and
      // re-renders the job postings list.  If there is no current value,
      // defaults to the first specialty.
      function populateJobSpecialties() {
        const sel = document.getElementById('jobSpecialtySelect');
        if (!sel) return;
        sel.innerHTML = '';
        specialties.forEach(spec => {
          const opt = document.createElement('option');
          opt.value = spec.key;
          opt.textContent = spec.name;
          sel.appendChild(opt);
        });
        if (specialties.length > 0) {
          state.jobSpecialtyKey = specialties[0].key;
          sel.value = state.jobSpecialtyKey;
        }
        sel.addEventListener('change', () => {
          state.jobSpecialtyKey = sel.value;
          renderJobCards();
        });
      }
      // Setup controls and event listeners
      function setupControls() {
        const real = document.getElementById('toggleReal');
        const house = document.getElementById('toggleHouse');
        const car = document.getElementById('toggleCar');
        const family = document.getElementById('toggleFamily');
        const housePrice = document.getElementById('housePrice');
        const carPrice = document.getElementById('carPrice');
        const familyCost = document.getElementById('familyCost');
        // defaults
        housePrice.value = state.house.price;
        carPrice.value = state.car.price;
        familyCost.value = state.family.annual_cost;
        // toggles
        real.addEventListener('change', () => { state.showReal = real.checked; updateAll(); });
        house.addEventListener('change', () => { state.toggles.house = house.checked; updateAll(); });
        car.addEventListener('change', () => { state.toggles.car = car.checked; updateAll(); });
        family.addEventListener('change', () => { state.toggles.family = family.checked; updateAll(); });
        // inputs
        housePrice.addEventListener('input', () => { const v = parseFloat(housePrice.value); if (!isNaN(v)) state.house.price = v; updateAll(); });
        carPrice.addEventListener('input', () => { const v = parseFloat(carPrice.value); if (!isNaN(v)) state.car.price = v; updateAll(); });
        familyCost.addEventListener('input', () => { const v = parseFloat(familyCost.value); if (!isNaN(v)) state.family.annual_cost = v; updateAll(); });
      }
      // Update snapshot cards
      function updateSnapshots(spec, series) {
        const snap = document.getElementById('snapshots');
        snap.innerHTML = '';
        const card = (title, value) => {
          const div = document.createElement('div');
          div.className = 'col-md-3 mb-3';
          div.innerHTML = `<div class="card shadow-sm"><div class="card-body"><h6 class="card-title text-muted">${title}</h6><p class="card-text fs-5 fw-semibold">${value}</p></div></div>`;
          return div;
        };
        snap.appendChild(card('Gross (yr 1)', fmtEuro(series.gross[0])));
        snap.appendChild(card('Net (yr 1)', fmtEuro(series.net[0])));
        snap.appendChild(card('Hours/week', spec.hours_per_week));
        snap.appendChild(card('Doctors in Sevilla', spec.doctors_est));
      }
      // Render job postings
      function renderJobCards() {
        const list = document.getElementById('jobList');
        list.innerHTML = '';
        // If no job specialty is selected, default to first specialty in array
        const specKey = state.jobSpecialtyKey || (specialties.length ? specialties[0].key : null);
        if (!specKey) return;
        const filtered = jobs.filter(j => j.specialty_key === specKey);
        // Display average salary and number of postings
        if (filtered.length > 0) {
          let sumGross = 0;
          let sumNet = 0;
          filtered.forEach(j => {
            const mid = ((j.salary_gross_min || 0) + (j.salary_gross_max || j.salary_gross_min || 0)) / 2;
            sumGross += mid;
            sumNet += mid - incomeTax(mid) - socialSecurity(mid);
          });
          const avgGross = sumGross / filtered.length;
          const avgNet = sumNet / filtered.length;
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'col-12 mb-2';
          const uniqueSpecs = Array.from(new Set(jobs.map(j => j.specialty_key)));
          const avgCount = (jobs.length / uniqueSpecs.length).toFixed(1);
          summaryDiv.innerHTML =
            `<div class="alert alert-info">` +
            `Average gross salary: <strong>${fmtEuro(avgGross)}</strong> — Average net salary after tax & social security: <strong>${fmtEuro(avgNet)}</strong>` +
            `<br><small>Based on ${filtered.length} posting${filtered.length > 1 ? 's' : ''}. Average postings per specialty in this dataset: ${avgCount}</small>` +
            `</div>`;
          list.appendChild(summaryDiv);
        }
        filtered.forEach(job => {
          const div = document.createElement('div');
          div.className = 'col-md-6 col-lg-4 mb-3';
          const salaryPart = job.salary_gross_max && job.salary_gross_max !== job.salary_gross_min
            ? `${fmtEuro(job.salary_gross_min)}–${fmtEuro(job.salary_gross_max)}`
            : fmtEuro(job.salary_gross_min);
          // Compute net salary for this job posting
          const mid = ((job.salary_gross_min || 0) + (job.salary_gross_max || job.salary_gross_min || 0)) / 2;
          const netSal = mid - incomeTax(mid) - socialSecurity(mid);
          div.innerHTML = `<div class="card h-100"><div class="card-body"><h6 class="card-title">${job.title}</h6><p class="small text-muted mb-1">${job.employer}</p><p class="mb-1"><strong>Salary:</strong> ${salaryPart}</p><p class="mb-1"><strong>Net:</strong> ${fmtEuro(netSal)}</p><p class="mb-1"><strong>Contract:</strong> ${job.contract}</p><a href="${job.source}" target="_blank" class="small">Source</a></div></div>`;
          list.appendChild(div);
        });
      }
      // Render market cap summary table
      function renderMarketCap() {
        const tableDiv = document.getElementById('marketTable');
        if (!tableDiv) return;
        let html = '<table class="table table-striped"><thead><tr><th>Specialty</th><th>Doctors</th><th>Base Salary</th><th>Total Payroll</th></tr></thead><tbody>';
        let totalPayroll = 0;
        let totalDoctors = 0;
        specialties.forEach(s => {
          const payroll = s.doctors_est * s.gross_base;
          totalPayroll += payroll;
          totalDoctors += s.doctors_est;
          html += `<tr><td>${s.name}</td><td>${s.doctors_est}</td><td>${fmtEuro(s.gross_base)}</td><td>${fmtEuro(payroll)}</td></tr>`;
        });
        html += `<tr class="fw-bold"><td>Total</td><td>${totalDoctors}</td><td></td><td>${fmtEuro(totalPayroll)}</td></tr>`;
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      }

      // Render table of hospitals with estimated doctors and revenues.  Uses the
      // doctorsPerBed constant to convert bed counts into approximate numbers of
      // doctors.  Private hospitals list revenue where available; public
      // hospitals leave revenue blank.  A total row sums beds and doctors.
      function renderHospitals() {
        const tableDiv = document.getElementById('hospitalTable');
        if (!tableDiv) return;
        let html = '<table class="table table-striped"><thead><tr><th>Hospital</th><th>Sector</th><th>Beds</th><th>Est. Doctors</th><th>Revenue</th></tr></thead><tbody>';
        let totalBeds = 0;
        let totalDocs = 0;
        hospitals.forEach(h => {
          const estDocs = Math.round(h.beds * doctorsPerBed);
          totalBeds += h.beds;
          totalDocs += estDocs;
          const revenue = h.revenue ? fmtEuro(h.revenue) : '—';
          html += `<tr><td>${h.name}</td><td>${h.sector}</td><td>${h.beds}</td><td>${estDocs}</td><td>${revenue}</td></tr>`;
        });
        html += `<tr class="fw-bold"><td>Total</td><td></td><td>${totalBeds}</td><td>${Math.round(totalDocs)}</td><td></td></tr>`;
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      }

      // Compute and render a ranking of specialties by average net salary based on
      // available job postings.  For each specialty we calculate the midpoint
      // salary of each posting, convert it to net by subtracting income tax and
      // social security, then average across postings.  The table is sorted
      // descending by average net salary.  If a specialty has no job postings,
      // it is omitted from the ranking.  We also display the number of
      // postings used for each specialty.
      function renderRanking() {
        const tableDiv = document.getElementById('rankingTable');
        if (!tableDiv) return;
        const rows = specialties.map(spec => {
          const postings = jobs.filter(j => j.specialty_key === spec.key);
          if (postings.length === 0) return null;
          let sumGross = 0;
          let sumNet = 0;
          postings.forEach(j => {
            const mid = ((j.salary_gross_min || 0) + (j.salary_gross_max || j.salary_gross_min || 0)) / 2;
            sumGross += mid;
            sumNet += mid - incomeTax(mid) - socialSecurity(mid);
          });
          return {
            name: spec.name,
            posts: postings.length,
            avgGross: sumGross / postings.length,
            avgNet: sumNet / postings.length
          };
        }).filter(Boolean);
        rows.sort((a, b) => b.avgNet - a.avgNet);
        let html = '<table class="table table-striped"><thead><tr><th>Specialty</th><th>Postings</th><th>Avg Gross</th><th>Avg Net</th></tr></thead><tbody>';
        rows.forEach(r => {
          html += `<tr><td>${r.name}</td><td>${r.posts}</td><td>${fmtEuro(r.avgGross)}</td><td>${fmtEuro(r.avgNet)}</td></tr>`;
        });
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      }
      // Update charts and UI
      function updateCharts() {
        const spec = specialties.find(s => s.key === state.specialtyKey);
        if (!spec) return;
        const series = buildSeries(spec);
        const labels = Array.from({ length: config.career_years }, (_, i) => i);
        annualChart.data.labels = labels;
        annualChart.data.datasets[0].data = state.showReal ? series.net_real : series.net;
        annualChart.data.datasets[1].data = state.showReal ? series.fcf_real : series.fcf;
        annualChart.update();
        wealthChart.data.labels = labels;
        wealthChart.data.datasets[0].data = series.cnw;
        wealthChart.data.datasets[1].data = series.cnw_real;
        wealthChart.update();
        // update mix chart highlighting selected specialty
        if (mixChart) {
          mixChart.data.datasets[0].backgroundColor = specialties.map(s => s.key === state.specialtyKey ? '#007bff' : '#6c757d');
          mixChart.update();
        }
        updateSnapshots(spec, series);
        renderJobCards();
      }
      // Main initialization
      function init() {
        populateSpecialties();
        setupControls();
        const annualCtx = document.getElementById('annualChart').getContext('2d');
        const wealthCtx = document.getElementById('wealthChart').getContext('2d');
        annualChart = new Chart(annualCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Net Income', data: [], borderColor: '#007bff', borderWidth: 2 },
              { label: 'Free Cash Flow', data: [], borderColor: '#28a745', borderWidth: 2 }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { ticks: { callback: v => fmtEuro(v) } } }
          }
        });
        wealthChart = new Chart(wealthCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'CNW', data: [], borderColor: '#007bff', borderWidth: 2 },
              { label: 'CNW (real €)', data: [], borderColor: '#6c757d', borderDash: [5,5], borderWidth: 2 }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { ticks: { callback: v => fmtEuro(v) } } }
          }
        });
        // Initialize mix chart (doctors per specialty)
        const mixCtx = document.getElementById('mixChart').getContext('2d');
        mixChart = new Chart(mixCtx, {
          type: 'bar',
          data: {
            labels: specialties.map(s => s.name),
            datasets: [{
              label: '# Doctors',
              data: specialties.map(s => s.doctors_est),
              backgroundColor: specialties.map(s => s.key === state.specialtyKey ? '#007bff' : '#6c757d')
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
        // Populate job specialty dropdown
        populateJobSpecialties();
        // Render tables: market cap, hospitals and ranking
        renderMarketCap();
        renderHospitals();
        renderRanking();

        window.updateAll = updateCharts;
        updateCharts();
      }
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>