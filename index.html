<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Market Insights — Sevilla</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container my-4">
    <header class="hero">
      <h1>Doctor Market Insights — Sevilla</h1>
      <p class="sub">Per-specialty earnings, taxes, hours, and long‑term affordability</p>
    </header>

    <!-- Controls section -->
    <div id="controls" class="section">
      <h2 class="h5 mb-3">Configuration</h2>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="specialtySelect" class="form-label">Select specialty</label>
          <select id="specialtySelect" class="form-select"></select>
        </div>
        <div class="col-md-8">
          <div class="row">
            <div class="col-md-3 form-check">
              <input class="form-check-input" type="checkbox" id="toggleReal">
              <label class="form-check-label" for="toggleReal">Show in real €</label>
            </div>
            <div class="col-md-3 form-check">
              <input class="form-check-input" type="checkbox" id="toggleHouse">
              <label class="form-check-label" for="toggleHouse">Include house</label>
            </div>
            <div class="col-md-3 form-check">
              <input class="form-check-input" type="checkbox" id="toggleCar">
              <label class="form-check-label" for="toggleCar">Include car</label>
            </div>
            <div class="col-md-3 form-check">
              <input class="form-check-input" type="checkbox" id="toggleFamily">
              <label class="form-check-label" for="toggleFamily">Include family</label>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-4 input-group">
              <span class="input-group-text">House €</span>
              <input type="number" id="housePrice" class="form-control" min="0">
            </div>
            <div class="col-md-4 input-group">
              <span class="input-group-text">Car €</span>
              <input type="number" id="carPrice" class="form-control" min="0">
            </div>
            <div class="col-md-4 input-group">
              <span class="input-group-text">Family €/yr</span>
              <input type="number" id="familyCost" class="form-control" min="0">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Snapshot cards -->
    <div id="snapshots" class="section">
    </div>

    <!-- Annual chart section -->
    <div class="section">
      <h2 class="h5 mb-3">Annual Income & Free Cash Flow</h2>
      <div style="height:300px;">
        <canvas id="annualChart"></canvas>
      </div>
    </div>

    <!-- Wealth chart section -->
    <div class="section">
      <h2 class="h5 mb-3">Cumulative Net Worth</h2>
      <div style="height:300px;">
        <canvas id="wealthChart"></canvas>
      </div>
    </div>

    <!-- Specialty mix bar chart placeholder -->
    <div id="mix" class="section">
      <h2 class="h5 mb-3">Specialty Mix</h2>
      <div id="mixChart" style="height:300px;"></div>
    </div>

    <!-- Job postings -->
    <div id="jobs" class="section">
      <h2 class="h5 mb-3">Job Postings (Sevilla)</h2>
      <div id="jobList" class="row"></div>
    </div>

    <!-- Notes & sources -->
    <footer id="notes" class="section">
      <h2 class="h5">Notes & Sources</h2>
      <ul>
        <li>Tax brackets combine Andalusian and national rates【226860511555268†L60-L67】.</li>
        <li>Working hours statistics: 55 % of Spanish doctors work over 40 hours/week; average week ranges 21–40 hours【920465131104645†L60-L63】.</li>
        <li>Salaries grow at an assumed 2 % annually to approximate inflation and seniority progression.</li>
        <li>Living expenses are set at €30 000/year; optional costs (house, car, family) are applied when selected.</li>
        <li>Job postings reflect publicly advertised positions and may not represent typical earnings for all practitioners【422727991652910†L188-L196】【927188265911143†L176-L181】【827367782107712†L34-L37】.</li>
      </ul>
    </footer>
  </div>

  <script type="module">
    import { loadData } from './js/data.js';
    import { state, loadSpecialtyOptions, setupControls, updateSnapshots, renderJobs } from './js/ui.js';
    import { buildSeries } from './js/calculations.js';
    import { makeAnnualChart, makeWealthChart } from './js/charts.js';

    const annualCtx = document.getElementById('annualChart').getContext('2d');
    const wealthCtx = document.getElementById('wealthChart').getContext('2d');
    const annualChart = makeAnnualChart(annualCtx);
    const wealthChart = makeWealthChart(wealthCtx);

    const data = await loadData();
    // populate specialty options
    loadSpecialtyOptions(data.specialties);
    setupControls();

    function updateCharts() {
      // find selected specialty
      const spec = data.specialties.find(s => s.key === state.specialtyKey);
      if (!spec) return;
      const params = {
        baseGross: spec.gross_base,
        years: data.config.career_years,
        salaryInfl: data.config.inflation_salary,
        taxBrackets: data.config.tax_brackets_andalucia_2025,
        ssRate: data.config.ss_employee_rate,
        mortgage: { ...data.config.mortgage, housePrice: state.house.price, startYear: state.house.startYear },
        car: { ...data.config.car, price: state.car.price, startYear: state.car.startYear },
        family: { annual_cost: state.family.annual_cost },
        toggles: { ...state.toggles },
        investReturn: data.config.investment_return,
        realCPI: state.showReal ? data.config.inflation_cpi : 0
      };
      const series = buildSeries(params);
      // update charts
      // update x‑axis labels for both charts
      annualChart.data.labels = Array.from({ length: data.config.career_years }, (_, i) => i);
      // Dataset 0 on the annual chart is the annual net income before expenses.
      // Dataset 1 is the free cash flow after optional expenses.
      annualChart.data.datasets[0].data = state.showReal ? series.net_real : series.net;
      annualChart.data.datasets[1].data = state.showReal ? series.fcf_real : series.fcf;
      annualChart.update();
      // For the wealth chart, always show nominal and real cumulative net worth
      wealthChart.data.labels = Array.from({ length: data.config.career_years }, (_, i) => i);
      wealthChart.data.datasets[0].data = series.cnw;
      wealthChart.data.datasets[1].data = series.cnw_real;
      wealthChart.update();
      // update snapshots
      updateSnapshots(spec, series);
      // update jobs
      renderJobs(data.jobs, state.specialtyKey);
    }
    // expose updateAll globally
    window.updateAll = updateCharts;
    // initial render
    updateCharts();
  </script>
</body>
</html>