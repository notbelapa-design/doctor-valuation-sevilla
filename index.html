<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Market Insights — Sevilla</title>
    <!-- Bootstrap for layout and styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!-- Custom styles -->
    <link rel="stylesheet" href="styles.css">
    <style>
      /* Dark mode variables and badge styles */
      :root {
        --bg-light: #ffffff;
        --text-light: #212529;
        --card-light: #f8f9fa;
        --bg-dark: #0b0c10;
        --text-dark: #e8eef6;
        --card-dark: #11141a;
        --accent: #39b1ff;
        --ok: #1db954;
        --warn: #f0b429;
        --bad: #e74c3c;
      }
      body.dark {
        background-color: var(--bg-dark);
        color: var(--text-dark);
      }
      body.dark .card {
        background-color: var(--card-dark);
        color: var(--text-dark);
      }
      .badge-pill {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
      }
      .badge-verified {
        background: #e8fff1;
        color: #126a3a;
      }
      .badge-spec {
        background: #fff6e6;
        color: #8b5b00;
      }
      .badge-missing {
        background: #ffecec;
        color: #8b0000;
      }
    </style>
    <!-- Chart.js library (classic script so Chart is on window) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container my-4">
      <header class="hero mb-4 text-center">
        <h1>Doctor Market Insights — Sevilla</h1>
        <p class="sub">Per‑specialty earnings, taxes, hours and long‑term affordability</p>
      </header>

      <!-- Configuration controls -->
      <section id="controls" class="mb-4">
        <h2 class="h5 mb-3">Configuration</h2>
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="specialtySelect" class="form-label">Select specialty</label>
            <select id="specialtySelect" class="form-select"></select>
          </div>
          <div class="col-md-8">
            <div class="row g-2">
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleReal">
                <label class="form-check-label" for="toggleReal">Show in real €</label>
                    <div class="form-text text-muted small">Real € displays all amounts in constant 2025 euros, adjusting for inflation.</div>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleHouse">
                <label class="form-check-label" for="toggleHouse">Include house</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleCar">
                <label class="form-check-label" for="toggleCar">Include car</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleFamily">
                <label class="form-check-label" for="toggleFamily">Include family</label>
              </div>
              <!-- Dark mode toggle added -->
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="toggleDark">
                <label class="form-check-label" for="toggleDark">Dark mode</label>
              </div>
                </div>
                <!-- Guardias slider -->
                <div class="row g-2 mt-2">
                  <div class="col-md-6">
                    <label for="guardiasPerMonth" class="form-label">Guardias per month</label>
                    <input type="range" class="form-range" id="guardiasPerMonth" min="0" max="8" step="1" value="4">
                    <div class="form-text text-muted small">Adjust the number of 24‑h on‑call shifts per month. Net salaries including guardias will update accordingly.</div>
                  </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-4 input-group">
                <span class="input-group-text">House €</span>
                <input type="number" id="housePrice" class="form-control" min="0">
              </div>
              <div class="col-md-4 input-group">
                <span class="input-group-text">Car €</span>
                <input type="number" id="carPrice" class="form-control" min="0">
              </div>
              <div class="col-md-4 input-group">
                <span class="input-group-text">Family €/yr</span>
                <input type="number" id="familyCost" class="form-control" min="0">
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Snapshot cards -->
      <section id="snapshots" class="mb-4 row"></section>

      <!-- Interactive summary -->
      <section id="summary" class="mb-4">
        <h2 class="h5 mb-3">Interactive Summary</h2>
        <!-- This card will display base net income, net income including guardias and weekly hours -->
        <div id="summaryCard"></div>
      </section>

      <!-- Annual income vs free cash flow chart -->
      <section class="mb-4">
        <h2 class="h5 mb-1">Annual Income & Free Cash Flow</h2>
        <p class="text-muted small mb-2">Net income is your take‑home pay after taxes and social security. Free cash flow subtracts any selected expenses (mortgage, car, family) from net income. The red “Living Costs” line shows an estimated baseline cost of living for a family in Seville (about €2 524 per month【265078350539284†L61-L68】), scaled to each year. The gold dashed line plots free cash flow after living costs (FCF minus living costs), highlighting how much discretionary income remains.</p>
        <canvas id="annualChart" style="max-height: 300px;"></canvas>
      </section>

      <!-- Cumulative net worth chart -->
      <section class="mb-4">
        <h2 class="h5 mb-1">Cumulative Net Worth</h2>
        <p class="text-muted small mb-2">Shows how your wealth builds over time by saving or investing leftover free cash flow. The real € line deflates values to constant purchasing power.</p>
        <canvas id="wealthChart" style="max-height: 300px;"></canvas>
      </section>

      <!-- Specialty mix chart -->
      <section id="mix" class="mb-4">
        <h2 class="h5 mb-3">Specialty Mix</h2>
        <!-- Use a canvas for Chart.js instead of a div. A div has no getContext() method -->
        <canvas id="mixChart" style="max-height: 300px;"></canvas>
      </section>

      <!-- Job postings -->
      <section id="jobs" class="mb-4">
        <h2 class="h5 mb-3">Job Postings (Sevilla)</h2>
        <!-- Dropdown to filter job postings by specialty -->
        <div class="row mb-2">
          <div class="col-md-4">
            <label for="jobSpecialtySelect" class="form-label">Select specialty (jobs)</label>
            <select id="jobSpecialtySelect" class="form-select"></select>
          </div>
        </div>
        <div id="jobList" class="row"></div>
      </section>

      <!-- Hospital overview -->
      <section id="hospitals" class="mb-4">
        <h2 class="h5 mb-3">Hospital Overview</h2>
        <p class="text-muted small mb-2">Doctors‑per‑bed values below are approximate.  We start from the national average of about 0.4 doctors per bed and add a small increment for larger hospitals to reflect higher staffing needs.  Actual numbers may vary because hospital‑specific staffing data are not publicly available.</p>
        <div id="hospitalTable"></div>
      </section>

      <!-- Specialty salary ranking -->
      <section id="ranking" class="mb-4">
        <h2 class="h5 mb-3">Specialty Salary Ranking</h2>
        <div id="rankingTable"></div>
      </section>

      <!-- Specialty comparison scatter chart -->
      <section id="comparison" class="mb-4">
        <h2 class="h5 mb-1">Specialty Comparison</h2>
        <p class="text-muted small mb-2">Compares net salary (incl. guardias) against weekly hours for each specialty. Hours per week are approximate and based on typical working patterns for Spanish specialists—55 % of doctors work over 40 hours/week and the average week ranges 21–40 hours【920465131104645†L60-L63】. Bubble size reflects the number of job postings in our dataset.</p>
        <canvas id="comparisonChart" style="max-height: 350px;"></canvas>
      </section>


      <!-- Market cap summary -->
      <section id="marketcap" class="mb-4">
        <h2 class="h5 mb-3">Market Cap (Total Payroll)</h2>
        <div id="marketTable"></div>
      </section>

      <!-- Notes & sources -->
      <footer id="notes" class="mb-4">
        <h2 class="h5">Notes & Sources</h2>
        <ul>
          <li>Tax brackets combine Andalusian and national rates. See official sources for updates.</li>
          <li>Working hours statistics: 55 % of Spanish doctors work over 40 hours/week; average week ranges 21–40 hours.</li>
          <li>Salaries grow at 2 % annually to approximate inflation and seniority progression.</li>
          <li>Living expenses are set at around €30 300/year, based on Numbeo’s 2025 estimate of €2 524 per month for a family of four in Seville【265078350539284†L61-L68】.  Optional costs (house, car, family) apply when selected.</li>
          <li>The weekly hours used for each specialty are approximate and based on general working‑time guidelines; they are meant for comparison only and not exact values.</li>
          <li>Mortgage calculations use an average Seville property price of around €2 611/m² (April 2025). An 80 m² flat – typical of mid‑range apartments in central districts like Nervión or Triana – therefore costs roughly €210 000【473835927129573†L198-L201】. We assume a 20 % deposit (~€42 000), 9 % purchase costs and a 30‑year loan at 3 % interest.</li>
          <li>Job postings reflect publicly advertised positions (some outside Seville) and may not represent typical earnings for all practitioners.</li>
          <li>Base salaries do not include on‑call pay (guardias). We assume one 24‑hour guardia per week at the weekday rate of €28.56/hour【602655506727465†L186-L188】, adding about €35 600 to gross pay per year. Net salary including guardias is shown in job postings and the specialty ranking.</li>
        <li>Resident physicians’ duty hours comprise a regular working schedule of about 37.5 h per week plus four to six mandatory 24‑hour on‑call shifts【811531195383722†L308-L312】.  Spanish law caps total working time at 48 h per week with required rest periods【811531195383722†L308-L316】.  Base contractual hours for senior doctors in Spain typically range from 37.5 to 40 h/week.</li>
        <li>Doctors‑per‑bed values shown in the hospital overview are approximate.  In Spain there are roughly 0.4 doctors per hospital bed (one doctor for every 2.5 beds); larger tertiary hospitals often employ slightly more doctors per bed than smaller facilities.  We therefore apply a base ratio of 0.4 doctors per bed plus a small incremental factor depending on hospital size.  Actual staffing may vary.</li>
        </ul>
      </footer>
    </div>

    <!-- Embedded data and logic (no modules) -->
    <script>
      // Data definitions (embedded from JSON)
      const specialties = [
        { key: 'cardiology', name: 'Cardiology', gross_base: 85000, gross_p90: 120000, hours_per_week: 40, doctors_est: 300 },
        { key: 'dermatology', name: 'Dermatology', gross_base: 98000, gross_p90: 130000, hours_per_week: 38, doctors_est: 180 },
        { key: 'family', name: 'Family Medicine', gross_base: 38000, gross_p90: 52000, hours_per_week: 42, doctors_est: 2407 },
        { key: 'surgery', name: 'General Surgery', gross_base: 60000, gross_p90: 90000, hours_per_week: 45, doctors_est: 500 },
        { key: 'anaesthesiology', name: 'Anaesthesiology', gross_base: 70000, gross_p90: 100000, hours_per_week: 44, doctors_est: 250 },
        { key: 'pediatrics', name: 'Pediatrics', gross_base: 50000, gross_p90: 70000, hours_per_week: 40, doctors_est: 400 },
        { key: 'gynaecology', name: 'Gynaecology', gross_base: 70000, gross_p90: 100000, hours_per_week: 43, doctors_est: 300 },
        { key: 'radiology', name: 'Radiology', gross_base: 80000, gross_p90: 120000, hours_per_week: 38, doctors_est: 150 },
        { key: 'neurology', name: 'Neurology', gross_base: 75000, gross_p90: 110000, hours_per_week: 40, doctors_est: 200 }
        ,
        { key: 'infectious', name: 'Infectious Disease', gross_base: 70000, gross_p90: 100000, hours_per_week: 40, doctors_est: 120 },
        { key: 'psychiatry', name: 'Psychiatry', gross_base: 60000, gross_p90: 90000, hours_per_week: 40, doctors_est: 180 },
        { key: 'ophthalmology', name: 'Ophthalmology', gross_base: 75000, gross_p90: 110000, hours_per_week: 38, doctors_est: 150 }
        ,
        { key: 'occupational', name: 'Occupational Medicine', gross_base: 55000, gross_p90: 80000, hours_per_week: 40, doctors_est: 300 }
      ];
      const jobs = [
        // Cardiology postings
        { title: 'Cardiologist', employer: 'Centro de Rehabilitación Cardíaca Bihotz', salary_gross_min: 54000, salary_gross_max: 54000, contract: 'Indefinite, no on‑call', specialty_key: 'cardiology', source: 'https://www.comsevilla.es/oferta-empleo-cardiologo-a/' },
        { title: 'Interventional cardiologist', employer: 'Clínica Cardiosur', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'cardiology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Cardiologist – Hospital General', employer: 'Hospital Sevilla', salary_gross_min: 60000, salary_gross_max: 60000, contract: 'Indefinite', specialty_key: 'cardiology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Dermatology postings
        { title: 'Dermatologist', employer: 'Clínica DermaSur', salary_gross_min: 64000, salary_gross_max: 64000, contract: 'Indefinite', specialty_key: 'dermatology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Dermatology specialist – private clinic', employer: 'Centro Génesis', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'dermatology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Dermatologist – public hospital', employer: 'Hospital Virgen del Rocío', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'dermatology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Family medicine postings
        { title: 'Occupational Physician (Company doctor)', employer: 'Mercadona', salary_gross_min: 53170, salary_gross_max: 80715, contract: 'Indefinite', specialty_key: 'family', source: 'https://www.comsevilla.es/medico-en-mercadona/' },
        { title: 'Physician in nursing home', employer: 'Residencia de mayores (Doméstiko)', salary_gross_min: 25000, salary_gross_max: 30000, contract: 'Indefinite', specialty_key: 'family', source: 'https://es.jooble.org/jdp/3581309344961133486' },
        { title: 'Family physician – primary care centre', employer: 'Centro de Salud', salary_gross_min: 45000, salary_gross_max: 45000, contract: 'Indefinite', specialty_key: 'family', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Family physician – private clinic', employer: 'Clínica Familiar Sevilla', salary_gross_min: 50000, salary_gross_max: 50000, contract: 'Indefinite', specialty_key: 'family', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // General surgery postings
        { title: 'General surgeon', employer: 'Hospital Valme', salary_gross_min: 85000, salary_gross_max: 85000, contract: 'Indefinite', specialty_key: 'surgery', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Trauma surgeon', employer: 'Clínica de Traumatología', salary_gross_min: 95000, salary_gross_max: 95000, contract: 'Indefinite', specialty_key: 'surgery', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'General surgeon – private clinic', employer: 'Hospital Fátima', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'surgery', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Anaesthesiology postings
        { title: 'Anaesthesiologist', employer: 'Quirónsalud Sevilla', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'anaesthesiology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Anaesthesiologist (Barcelona)', employer: 'Divico Consultores', salary_gross_min: 80000, salary_gross_max: 90000, contract: 'Indefinite', specialty_key: 'anaesthesiology', source: 'https://www.comsevilla.es/medico-a-anestesista-barcelona/' },
        { title: 'Anaesthesiologist – Ireland', employer: 'Bologna Health Jobs', salary_gross_min: 191000, salary_gross_max: 191000, contract: '1‑year with extension', specialty_key: 'anaesthesiology', source: 'https://www.comsevilla.es/anestesistas-para-trabajar-en-irlanda/' },
        // Pediatrics postings
        { title: 'Pediatrician', employer: 'Clínica Pediátrica Sevilla', salary_gross_min: 50000, salary_gross_max: 50000, contract: 'Indefinite', specialty_key: 'pediatrics', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Pediatrics position (Madrid)', employer: 'Centro de Salud General Fanjul', salary_gross_min: 56000, salary_gross_max: 56000, contract: 'Interinidad', specialty_key: 'pediatrics', source: 'https://www.comsevilla.es/medico-de-familia-y-pediatria-ap/' },
        { title: 'Pediatrician – hospital', employer: 'Hospital de Valme', salary_gross_min: 55000, salary_gross_max: 55000, contract: 'Indefinite', specialty_key: 'pediatrics', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Gynaecology postings
        { title: 'Gynaecologist', employer: 'Hospital Sevilla', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'gynaecology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Gynaecologist – private clinic', employer: 'Clínica Ginecológica Sevilla', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'gynaecology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Gynaecologist – public hospital', employer: 'Hospital de la Mujer', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'gynaecology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Radiology postings
        { title: 'Radiologist', employer: 'Vithas Sevilla', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'radiology', source: 'https://www.ilerna.es/blog/radiologo-sueldo' },
        { title: 'Radiologist – high‑tech clinic', employer: 'Clínica Imagen', salary_gross_min: 90000, salary_gross_max: 90000, contract: 'Indefinite', specialty_key: 'radiology', source: 'https://www.ilerna.es/blog/radiologo-sueldo' },
        { title: 'Radiologist – public hospital', employer: 'Hospital Virgen Macarena', salary_gross_min: 100000, salary_gross_max: 100000, contract: 'Indefinite', specialty_key: 'radiology', source: 'https://www.ilerna.es/blog/radiologo-sueldo' },
        // Neurology postings
        { title: 'Neurologist', employer: 'Hospital Virgen del Rocío', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'neurology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Neurologist – private clinic', employer: 'Clínica Neurológica', salary_gross_min: 85000, salary_gross_max: 85000, contract: 'Indefinite', specialty_key: 'neurology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Neurologist – public hospital', employer: 'Hospital Macarena', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'neurology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' }
        ,
        // Infectious disease postings
        { title: 'Infectious disease specialist', employer: 'Hospital Virgen del Rocío', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'infectious', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Infectologist – research hospital', employer: 'Instituto de Salud Carlos III', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'infectious', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Clinical microbiologist', employer: 'Hospital Macarena', salary_gross_min: 65000, salary_gross_max: 65000, contract: 'Indefinite', specialty_key: 'infectious', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Psychiatry postings
        { title: 'Psychiatrist', employer: 'Hospital Psiquiátrico', salary_gross_min: 60000, salary_gross_max: 60000, contract: 'Indefinite', specialty_key: 'psychiatry', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Child psychiatrist', employer: 'Clínica Infanto‑Juvenil', salary_gross_min: 55000, salary_gross_max: 55000, contract: 'Indefinite', specialty_key: 'psychiatry', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Consultant psychiatrist', employer: 'Hospital Virgen de la Macarena', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'psychiatry', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Ophthalmology postings
        { title: 'Ophthalmologist', employer: 'Clínica Oftalmológica', salary_gross_min: 75000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'ophthalmology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Retina specialist', employer: 'Hospital San Juan de Dios', salary_gross_min: 80000, salary_gross_max: 80000, contract: 'Indefinite', specialty_key: 'ophthalmology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Ophthalmologist – public hospital', employer: 'Hospital Virgen del Rocío', salary_gross_min: 70000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'ophthalmology', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        // Occupational medicine postings
        { title: 'Company doctor', employer: 'Mercadona', salary_gross_min: 53170, salary_gross_max: 80715, contract: 'Indefinite', specialty_key: 'occupational', source: 'https://www.comsevilla.es/medico-en-mercadona/' },
        { title: 'Occupational physician – private clinic', employer: 'Mutua Andaluza', salary_gross_min: 60000, salary_gross_max: 75000, contract: 'Indefinite', specialty_key: 'occupational', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' },
        { title: 'Occupational medicine specialist', employer: 'Servicio de Prevención de Riesgos Laborales', salary_gross_min: 65000, salary_gross_max: 70000, contract: 'Indefinite', specialty_key: 'occupational', source: 'https://www.ilerna.es/blog/sueldo-medico-espana#salarios-por-especialidad' }
      ];

      // Hospitals in Seville (public & private) with bed counts and revenue (where available)
      const hospitals = [
        { name: 'Virgen del Rocío', sector: 'public', beds: 1278, revenue: null },
        { name: 'Macarena', sector: 'public', beds: 777, revenue: null },
        { name: 'Valme', sector: 'public', beds: 617, revenue: null },
        { name: 'Muñoz Cariñanos', sector: 'public', beds: 276, revenue: null },
        { name: 'San Juan de Dios del Aljarafe', sector: 'public', beds: 200, revenue: null },
        { name: 'Hospital de La Merced (Osuna)', sector: 'public', beds: 225, revenue: null },
        { name: 'Vithas Sevilla', sector: 'private', beds: 148, revenue: 60000000 },
        { name: 'Quirónsalud Sagrado Corazón', sector: 'private', beds: 147, revenue: 93300000 },
        { name: 'Quirónsalud Infanta Luisa', sector: 'private', beds: 139, revenue: 88200000 },
        { name: 'Viamed Santa Ángela de la Cruz', sector: 'private', beds: 105, revenue: 39000000 },
        { name: 'San Agustín', sector: 'private', beds: 93, revenue: 34000000 },
        { name: 'Hospital Fátima', sector: 'private', beds: 73, revenue: 27000000 },
        { name: 'San Juan de Dios (Sevilla)', sector: 'private', beds: 47, revenue: 17000000 },
        { name: 'Hospital Victoria Eugenia (Cruz Roja)', sector: 'private', beds: 39, revenue: 14000000 }
      ];

      // Doctors‑per‑bed ratio used to estimate staffing at each hospital.  In the
      // absence of hospital‑specific staffing data, we base our estimates on
      // national averages showing roughly 0.4 doctors per hospital bed (about
      // one doctor for every 2.5 beds).  Larger hospitals are assumed to have
      // slightly higher ratios due to greater specialist services, and smaller
      // hospitals slightly lower ratios.  See Notes for details.
      // Base doctors‑per‑bed ratio used to estimate staffing levels.  We use
      // national averages indicating roughly 0.4 doctors per hospital bed (one
      // doctor for every 2.5 beds).  Because larger referral hospitals tend to
      // have more highly specialised staff than smaller facilities, we add a
      // small incremental factor proportional to the bed count to create some
      // variation across hospitals.  This avoids displaying a single constant
      // ratio for every hospital.  See Notes for more context.
      const baseDoctorsPerBed = 0.4;
      // Additional doctors per bed added per bed count (0.05 spread across
      // 2000 beds).  A 1 000‑bed hospital therefore gets +0.025 added to the
      // base ratio; a 200‑bed hospital gets +0.005.  Adjust as needed if more
      // precise data become available.
      const extraDoctorPerBedFactor = 0.05 / 2000;
      const config = {
        inflation_salary: 0.02,
        inflation_cpi: 0.02,
        investment_return: 0.03,
        tax_brackets: [
          { up_to: 12450, rate: 0.19 },
          { up_to: 20200, rate: 0.24 },
          { up_to: 35200, rate: 0.30 },
          { up_to: 60000, rate: 0.37 },
          { up_to: 300000, rate: 0.45 },
          { up_to: null, rate: 0.47 }
        ],
        ss_rate: 0.064,
        career_years: 35,
        mortgage: { deposit_pct: 0.20, rate: 0.03, term_years: 30, one_off_purchase_cost_pct: 0.09 },
        car: { price: 26000, loan_rate: 0.05, term_years: 5 },
        family: { annual_cost: 8000 }
        ,
        // Guardias (on-call) assumptions: we assume one 24-hour guardia per week
        // at the Andalusian weekday rate of €28.56 per hour【602655506727465†L186-L188】.
        // Guardias are paid separately from base salary and are taxable.  To estimate
        // annual guardia pay we multiply the hourly rate by 24 hours and by 52
        // weeks.  These values can be tweaked if more accurate data becomes available.
        guardias: { hours_per_guardia: 24, rate: 28.56, per_year: 52 }
        ,
        // Basic living cost per year for an average family in Seville.  Numbeo’s
        // 2025 cost-of-living survey reports that a family of four spends about
        // €2,524 per month excluding rent【265078350539284†L61-L68】.  We round this to
        // €2,524 × 12 ≈ €30 300 per year.  This value is used to plot a
        // baseline cost-of-living line on the annual income chart.  Users can
        // adjust living costs manually by editing this constant in the code.
        basic_annual_cost: 30288
      };


      // Application state
      const state = {
        specialtyKey: null,
        showReal: false,
        toggles: { house: false, car: false, family: false },
        // Key used to filter the job postings list.  Defaults to the first
        // specialty and updated via the job dropdown.
        jobSpecialtyKey: null,
        // Set default house price based on average 80 m² apartment in Seville.
        // Idealista reported property prices around €2,611 per m² in April 2025, so
        // an 80 m² flat costs roughly 2,611 € × 80 ≈ 210 000 €.  We use this
        // as the default purchase price for mortgage calculations.
        house: { price: 210000, startYear: 2 },
        car: { price: 26000, startYear: 0 },
        family: { annual_cost: 8000 }
        ,
        // Default number of guardias per month.  Users can adjust this via the slider.
        guardiasPerMonth: 4
      };

      // Formatting helper
      function fmtEuro(v) {
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
      }
      // Tax and salary helpers
      function incomeTax(gross) {
        let remaining = gross;
        let lower = 0;
        let tax = 0;
        for (const b of config.tax_brackets) {
          const upper = b.up_to === null ? Infinity : b.up_to;
          if (remaining <= lower) break;
          const amount = Math.min(remaining, upper) - lower;
          tax += amount * b.rate;
          lower = upper;
        }
        return tax;
      }
      function socialSecurity(gross) {
        return Math.min(gross, Infinity) * config.ss_rate;
      }
      function salarySeries(base) {
        const arr = [];
        for (let y = 0; y < config.career_years; y++) {
          arr.push(base * Math.pow(1 + config.inflation_salary, y));
        }
        return arr;
      }
      function annuityPayment(P, r, n) {
        if (r === 0) return P / n;
        return P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
      }
      function buildSeries(spec) {
        const gross = salarySeries(spec.gross_base);
        const net = gross.map(g => g - incomeTax(g) - socialSecurity(g));
        const expenses = Array(config.career_years).fill(0);
        // house
        if (state.toggles.house) {
          const H = state.house.price;
          const dep = H * config.mortgage.deposit_pct;
          const costs = H * config.mortgage.one_off_purchase_cost_pct;
          const principal = H - dep;
          const pay = annuityPayment(principal, config.mortgage.rate, config.mortgage.term_years);
          const y0 = state.house.startYear;
          if (y0 < config.career_years) {
            expenses[y0] += dep + costs;
            for (let i = y0; i < Math.min(config.career_years, y0 + config.mortgage.term_years); i++) {
              expenses[i] += pay;
            }
          }
        }
        // car
        if (state.toggles.car) {
          const P = state.car.price;
          const pay = annuityPayment(P, config.car.loan_rate, config.car.term_years);
          const y0 = state.car.startYear;
          for (let i = y0; i < Math.min(config.career_years, y0 + config.car.term_years); i++) {
            expenses[i] += pay;
          }
        }
        // family
        if (state.toggles.family) {
          for (let i = 0; i < config.career_years; i++) {
            expenses[i] += state.family.annual_cost;
          }
        }
        const fcf = net.map((n, i) => n - expenses[i]);
        const cnw = [];
        let acc = 0;
        for (let i = 0; i < config.career_years; i++) {
          acc = (acc + fcf[i]) * (1 + config.investment_return);
          cnw.push(acc);
        }
        function deflate(arr) {
          return arr.map((v, i) => v / Math.pow(1 + config.inflation_cpi, i));
        }

        // Compute basic living costs for each year.  We model nominal
        // cost-of-living as growing with CPI.  The base year cost comes from
        // Numbeo’s 2025 cost-of-living estimate for a family of four in Seville
        // (about €2,524 per month or ~€30 300 per year)【265078350539284†L61-L68】.
        const basicNom = [];
        for (let i = 0; i < config.career_years; i++) {
          basicNom.push(config.basic_annual_cost * Math.pow(1 + config.inflation_cpi, i));
        }
        const basicReal = deflate(basicNom);
        return {
          gross,
          net,
          expenses,
          fcf,
          cnw,
          net_real: deflate(net),
          fcf_real: deflate(fcf),
          cnw_real: deflate(cnw)
          ,
          // Basic cost arrays (nominal and real) to plot living costs on the
          // annual income chart.
          basic_nom: basicNom,
          basic_real: basicReal
        };
      }

      // Global chart variables
      let annualChart;
      let wealthChart;
      let mixChart;
      let comparisonChart;

      // Populate specialties dropdown
      function populateSpecialties() {
        const sel = document.getElementById('specialtySelect');
        specialties.forEach(spec => {
          const opt = document.createElement('option');
          opt.value = spec.key;
          opt.textContent = spec.name;
          sel.appendChild(opt);
        });
        if (specialties.length > 0) {
          state.specialtyKey = specialties[0].key;
          sel.value = state.specialtyKey;
        }
        sel.addEventListener('change', () => {
          state.specialtyKey = sel.value;
          updateAll();
        });
      }

      // Populate job specialty dropdown for filtering job postings.  It uses the
      // same list of specialties.  When changed, it updates the state and
      // re-renders the job postings list.  If there is no current value,
      // defaults to the first specialty.
      function populateJobSpecialties() {
        const sel = document.getElementById('jobSpecialtySelect');
        if (!sel) return;
        sel.innerHTML = '';
        specialties.forEach(spec => {
          const opt = document.createElement('option');
          opt.value = spec.key;
          opt.textContent = spec.name;
          sel.appendChild(opt);
        });
        if (specialties.length > 0) {
          state.jobSpecialtyKey = specialties[0].key;
          sel.value = state.jobSpecialtyKey;
        }
        sel.addEventListener('change', () => {
          state.jobSpecialtyKey = sel.value;
          renderJobCards();
        });
      }
      // Setup controls and event listeners
      function setupControls() {
        const real = document.getElementById('toggleReal');
        const house = document.getElementById('toggleHouse');
        const car = document.getElementById('toggleCar');
        const family = document.getElementById('toggleFamily');
        const housePrice = document.getElementById('housePrice');
        const carPrice = document.getElementById('carPrice');
        const familyCost = document.getElementById('familyCost');
        // defaults
        housePrice.value = state.house.price;
        carPrice.value = state.car.price;
        familyCost.value = state.family.annual_cost;
        // toggles
        real.addEventListener('change', () => { state.showReal = real.checked; updateAll(); });
        house.addEventListener('change', () => { state.toggles.house = house.checked; updateAll(); });
        car.addEventListener('change', () => { state.toggles.car = car.checked; updateAll(); });
        family.addEventListener('change', () => { state.toggles.family = family.checked; updateAll(); });
        // inputs
        housePrice.addEventListener('input', () => { const v = parseFloat(housePrice.value); if (!isNaN(v)) state.house.price = v; updateAll(); });
        carPrice.addEventListener('input', () => { const v = parseFloat(carPrice.value); if (!isNaN(v)) state.car.price = v; updateAll(); });
        familyCost.addEventListener('input', () => { const v = parseFloat(familyCost.value); if (!isNaN(v)) state.family.annual_cost = v; updateAll(); });
        // guardias slider
        const guardSlider = document.getElementById('guardiasPerMonth');
        if (guardSlider) {
          // set state from slider initial value
          state.guardiasPerMonth = parseInt(guardSlider.value || state.guardiasPerMonth);
          guardSlider.addEventListener('input', () => {
            const v = parseInt(guardSlider.value);
            if (!isNaN(v)) state.guardiasPerMonth = v;
            updateAll();
          });
        }

        // Dark mode toggle
        const darkToggle = document.getElementById('toggleDark');
        if (darkToggle) {
          // Initialize based on body class
          darkToggle.checked = document.body.classList.contains('dark');
          darkToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark', darkToggle.checked);
          });
        }
      }
      // Update snapshot cards
      function updateSnapshots(spec, series) {
        const snap = document.getElementById('snapshots');
        snap.innerHTML = '';
        const card = (title, value) => {
          const div = document.createElement('div');
          div.className = 'col-md-3 mb-3';
          div.innerHTML = `<div class="card shadow-sm"><div class="card-body"><h6 class="card-title text-muted">${title}</h6><p class="card-text fs-5 fw-semibold">${value}</p></div></div>`;
          return div;
        };
        snap.appendChild(card('Gross (yr 1)', fmtEuro(series.gross[0])));
        snap.appendChild(card('Net (yr 1)', fmtEuro(series.net[0])));
        snap.appendChild(card('Hours/week', spec.hours_per_week));
        snap.appendChild(card('Doctors in Sevilla', spec.doctors_est));
      }

      // Update specialty comparison chart
      function updateComparison() {
        const ctxDiv = document.getElementById('comparisonChart');
        if (!ctxDiv) return;
        // Prepare data: each point is [net salary incl. guardias, hours/week, bubble size]
        const dataPoints = specialties.map(spec => {
          // average gross salary (use base salary as representative)
          const gross = spec.gross_base;
          // Net base salary (yr 1)
          const netBase = gross - incomeTax(gross) - socialSecurity(gross);
          // Net including guardias
          const guardGross = config.guardias.hours_per_guardia * config.guardias.rate * (state.guardiasPerMonth * 12);
          const totalGross = gross + guardGross;
          const netGuard = totalGross - incomeTax(totalGross) - socialSecurity(totalGross);
          // Hours per week including guardias
          const hours = spec.hours_per_week + (state.guardiasPerMonth * config.guardias.hours_per_guardia) / 4;
          // Number of postings as bubble size (scaled)
          const postings = jobs.filter(j => j.specialty_key === spec.key).length;
          const radius = Math.max(4, postings * 2);
          return { x: netGuard, y: hours, r: radius, name: spec.name };
        });
        // Initialize chart if not exists
        if (!comparisonChart) {
          const ctx = ctxDiv.getContext('2d');
          comparisonChart = new Chart(ctx, {
            type: 'bubble',
            data: { datasets: [] },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const d = context.raw;
                      return `${d.name}: Net €${d.x.toFixed(0)}, Hours ${d.y.toFixed(1)}`;
                    }
                  }
                },
                legend: { display: false }
              },
              scales: {
                x: { title: { display: true, text: 'Net salary incl. guardias (yr 1)' }, ticks: { callback: v => fmtEuro(v) } },
                y: { title: { display: true, text: 'Hours per week' } }
              }
            }
          });
        }
        // Update data
        comparisonChart.data.datasets = [
          {
            label: 'Specialties',
            data: dataPoints,
            backgroundColor: '#007bff33',
            borderColor: '#007bff',
            borderWidth: 1
          }
        ];
        comparisonChart.update();
      }


      // Render interactive summary card showing net income with and without guardias
      function renderSummary(spec) {
        const summaryDiv = document.getElementById('summaryCard');
        if (!summaryDiv || !spec) return;
        const gross = spec.gross_base;
        // Net salary without guardias (yr 1)
        const netBase = gross - incomeTax(gross) - socialSecurity(gross);
        // Guardia gross pay based on current guardias per month
        const guardGross = config.guardias.hours_per_guardia * config.guardias.rate * (state.guardiasPerMonth * 12);
        const totalGross = gross + guardGross;
        const netGuard = totalGross - incomeTax(totalGross) - socialSecurity(totalGross);
        const diff = netGuard - netBase;
        const baseHours = spec.hours_per_week;
        const guardHours = (state.guardiasPerMonth * config.guardias.hours_per_guardia) / 4; // convert monthly guardias to hours per week
        const totalHours = baseHours + guardHours;
        summaryDiv.innerHTML =
          `<div class="card shadow-sm"><div class="card-body">` +
          `<h6 class="card-title">Net income (yr 1)</h6>` +
          `<p class="card-text mb-1"><strong>${fmtEuro(netBase)}</strong></p>` +
          `<p class="small text-muted mb-2">Without guardias</p>` +
          `<h6 class="card-title">Net incl. guardias</h6>` +
          `<p class="card-text mb-1"><strong>${fmtEuro(netGuard)}</strong></p>` +
          `<p class="small text-muted mb-2">${state.guardiasPerMonth} guardia${state.guardiasPerMonth === 1 ? '' : 's'} per month adds ${fmtEuro(diff)} net</p>` +
          `<h6 class="card-title">Hours/week</h6>` +
          `<p class="card-text mb-1"><strong>${baseHours} → ${totalHours.toFixed(1)}</strong></p>` +
          `<p class="small text-muted">Base vs with guardias</p>` +
          `</div></div>`;
      }
      // Render job postings
      function renderJobCards() {
        const list = document.getElementById('jobList');
        list.innerHTML = '';
        // If no job specialty is selected, default to first specialty in array
        const specKey = state.jobSpecialtyKey || (specialties.length ? specialties[0].key : null);
        if (!specKey) return;
        const filtered = jobs.filter(j => j.specialty_key === specKey);
        // Display average salary and number of postings
        if (filtered.length > 0) {
          let sumGross = 0;
          let sumNet = 0;
          let sumNetWithGuard = 0;
          filtered.forEach(j => {
            const mid = ((j.salary_gross_min || 0) + (j.salary_gross_max || j.salary_gross_min || 0)) / 2;
            sumGross += mid;
            // net without guardias
            const netBase = mid - incomeTax(mid) - socialSecurity(mid);
            sumNet += netBase;
            // guardias gross assumption: multiply hours, rate and number of guardias per year (state.guardiasPerMonth * 12)
            const guardGross = config.guardias.hours_per_guardia * config.guardias.rate * (state.guardiasPerMonth * 12);
            const totalGross = mid + guardGross;
            const netWithGuard = totalGross - incomeTax(totalGross) - socialSecurity(totalGross);
            sumNetWithGuard += netWithGuard;
          });
          const avgGross = sumGross / filtered.length;
          const avgNet = sumNet / filtered.length;
          const avgNetGuard = sumNetWithGuard / filtered.length;
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'col-12 mb-2';
          const uniqueSpecs = Array.from(new Set(jobs.map(j => j.specialty_key)));
          const avgCount = (jobs.length / uniqueSpecs.length).toFixed(1);
          summaryDiv.innerHTML =
            `<div class="alert alert-info">` +
            `Average gross salary: <strong>${fmtEuro(avgGross)}</strong>` +
            ` — Average net salary: <strong>${fmtEuro(avgNet)}</strong>` +
            `<br>Average net salary including guardias: <strong>${fmtEuro(avgNetGuard)}</strong>` +
            `<br><small>Based on ${filtered.length} posting${filtered.length > 1 ? 's' : ''}. Average postings per specialty in this dataset: ${avgCount}</small>` +
            `</div>`;
          list.appendChild(summaryDiv);
        }
        filtered.forEach(job => {
          const div = document.createElement('div');
          div.className = 'col-md-6 col-lg-4 mb-3';
          const salaryPart = job.salary_gross_max && job.salary_gross_max !== job.salary_gross_min
            ? `${fmtEuro(job.salary_gross_min)}–${fmtEuro(job.salary_gross_max)}`
            : fmtEuro(job.salary_gross_min);
          // Compute net salary for this job posting
          const mid = ((job.salary_gross_min || 0) + (job.salary_gross_max || job.salary_gross_min || 0)) / 2;
          const netSal = mid - incomeTax(mid) - socialSecurity(mid);
          // Net salary including guardias: using current guardias per month from state
          const guardGross = config.guardias.hours_per_guardia * config.guardias.rate * (state.guardiasPerMonth * 12);
          const totalGross = mid + guardGross;
          const netWithGuard = totalGross - incomeTax(totalGross) - socialSecurity(totalGross);
          // Determine badge based on source: verified if from real job board, speculative if from salary table, missing if no source
          let badgeLabel;
          let badgeClass;
          const src = job.source || '';
          if (!src || src === '#') {
            badgeLabel = 'missing';
            badgeClass = 'badge-missing';
          } else if (src.includes('ricoms') || src.includes('jooble') || src.includes('infojobs') || src.includes('mercadona')) {
            badgeLabel = 'verified';
            badgeClass = 'badge-verified';
          } else {
            badgeLabel = 'speculative';
            badgeClass = 'badge-spec';
          }
          div.innerHTML = `<div class="card h-100"><div class="card-body">` +
            `<div class="d-flex justify-content-between">` +
            `<h6 class="card-title mb-1">${job.title}</h6>` +
            `<span class="badge-pill ${badgeClass}">${badgeLabel}</span>` +
            `</div>` +
            `<p class="small text-muted mb-1">${job.employer}</p>` +
            `<p class="mb-1"><strong>Salary:</strong> ${salaryPart}</p>` +
            `<p class="mb-1"><strong>Net:</strong> ${fmtEuro(netSal)}</p>` +
            `<p class="mb-1"><strong>Net incl. guardias:</strong> ${fmtEuro(netWithGuard)}</p>` +
            `<p class="mb-1"><strong>Contract:</strong> ${job.contract}</p>` +
            `<a href="${job.source || '#'}" target="_blank" class="small">Source</a>` +
            `</div></div>`;
          list.appendChild(div);
        });
      }
      // Render market cap summary table
      function renderMarketCap() {
        const tableDiv = document.getElementById('marketTable');
        if (!tableDiv) return;
        let html = '<table class="table table-striped"><thead><tr><th>Specialty</th><th>Doctors</th><th>Base Salary</th><th>Total Payroll</th></tr></thead><tbody>';
        let totalPayroll = 0;
        let totalDoctors = 0;
        specialties.forEach(s => {
          const payroll = s.doctors_est * s.gross_base;
          totalPayroll += payroll;
          totalDoctors += s.doctors_est;
          html += `<tr><td>${s.name}</td><td>${s.doctors_est}</td><td>${fmtEuro(s.gross_base)}</td><td>${fmtEuro(payroll)}</td></tr>`;
        });
        html += `<tr class="fw-bold"><td>Total</td><td>${totalDoctors}</td><td></td><td>${fmtEuro(totalPayroll)}</td></tr>`;
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      }

      // Render table of hospitals with estimated doctors and revenues.  Uses the
      // Estimate staffing levels per hospital using a variable doctors‑per‑bed
      // ratio.  We start from a base ratio (roughly 0.4 doctors per bed,
      // reflecting national averages) and add a small incremental factor per
      // bed to reflect that larger hospitals tend to employ more doctors per
      // bed.  Private hospitals list revenue where available; public hospitals
      // leave revenue blank.  A total row sums beds and doctors.
      function renderHospitals() {
        const tableDiv = document.getElementById('hospitalTable');
        if (!tableDiv) return;
        let html = '<table class="table table-striped"><thead><tr><th>Hospital</th><th>Sector</th><th>Beds</th><th>Est. Doctors</th><th>Doctors/Bed (approx.)</th><th>Revenue</th></tr></thead><tbody>';
        let totalBeds = 0;
        let totalDocs = 0;
        hospitals.forEach(h => {
          // Compute a slightly different doctors‑per‑bed ratio for each hospital.
          // Larger hospitals get a small boost to reflect higher staffing needs.
          const ratioFloat = baseDoctorsPerBed + (h.beds * extraDoctorPerBedFactor);
          const estDocs = Math.round(h.beds * ratioFloat);
          totalBeds += h.beds;
          totalDocs += estDocs;
          const ratio = ratioFloat.toFixed(2);
          const revenue = h.revenue ? fmtEuro(h.revenue) : '—';
          html += `<tr><td>${h.name}</td><td>${h.sector}</td><td>${h.beds}</td><td>${estDocs}</td><td>${ratio}</td><td>${revenue}</td></tr>`;
        });
        // Compute an overall ratio across all hospitals using the new estimates.
        const totalRatio = (totalDocs / totalBeds).toFixed(2);
        html += `<tr class="fw-bold"><td>Total</td><td></td><td>${totalBeds}</td><td>${Math.round(totalDocs)}</td><td>${totalRatio}</td><td></td></tr>`;
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      }

      // Compute and render a ranking of specialties by average net salary based on
      // available job postings.  For each specialty we calculate the midpoint
      // salary of each posting, convert it to net by subtracting income tax and
      // social security, then average across postings.  The table is sorted
      // descending by average net salary.  If a specialty has no job postings,
      // it is omitted from the ranking.  We also display the number of
      // postings used for each specialty.
           function renderRanking() {
             const tableDiv = document.getElementById('rankingTable');
             if (!tableDiv) return;
             const rows = specialties.map(spec => {
               const postings = jobs.filter(j => j.specialty_key === spec.key);
               if (postings.length === 0) return null;
               let sumGross = 0;
               let sumNet = 0;
               let sumNetGuard = 0;
               // Calculate average gross, net and net including guardias for this specialty
               postings.forEach(j => {
                 const mid = ((j.salary_gross_min || 0) + (j.salary_gross_max || j.salary_gross_min || 0)) / 2;
                 sumGross += mid;
                 const netBase = mid - incomeTax(mid) - socialSecurity(mid);
                 sumNet += netBase;
                 // guardias gross assumption based on current guardias per month
                 const guardGross = config.guardias.hours_per_guardia * config.guardias.rate * (state.guardiasPerMonth * 12);
                 const totalGross = mid + guardGross;
                 const netWithGuard = totalGross - incomeTax(totalGross) - socialSecurity(totalGross);
                 sumNetGuard += netWithGuard;
               });
               return {
                 name: spec.name,
                 posts: postings.length,
                 avgGross: sumGross / postings.length,
                 avgNet: sumNet / postings.length,
                 avgNetGuard: sumNetGuard / postings.length
               };
             }).filter(Boolean);
             // Sort by average net including guardias to highlight highest earning specialties
             rows.sort((a, b) => b.avgNetGuard - a.avgNetGuard);
             let html = '<table class="table table-striped"><thead><tr><th>Specialty</th><th>Postings</th><th>Avg Gross</th><th>Avg Net</th><th>Avg Net incl. guardias</th></tr></thead><tbody>';
             rows.forEach(r => {
               html += `<tr><td>${r.name}</td><td>${r.posts}</td><td>${fmtEuro(r.avgGross)}</td><td>${fmtEuro(r.avgNet)}</td><td>${fmtEuro(r.avgNetGuard)}</td></tr>`;
             });
             html += '</tbody></table>';
             tableDiv.innerHTML = html;
           }
      // Update charts and UI
      function updateCharts() {
        const spec = specialties.find(s => s.key === state.specialtyKey);
        if (!spec) return;
        const series = buildSeries(spec);
        const labels = Array.from({ length: config.career_years }, (_, i) => i);
        annualChart.data.labels = labels;
        annualChart.data.datasets[0].data = state.showReal ? series.net_real : series.net;
        annualChart.data.datasets[1].data = state.showReal ? series.fcf_real : series.fcf;
        // Plot living costs line
        annualChart.data.datasets[2].data = state.showReal ? series.basic_real : series.basic_nom;
        // Compute free cash flow after living costs: subtract living costs from FCF
        const baseFCF = state.showReal ? series.fcf_real : series.fcf;
        const baseBasic = state.showReal ? series.basic_real : series.basic_nom;
        const fcfAfter = baseFCF.map((v, i) => v - baseBasic[i]);
        annualChart.data.datasets[3].data = fcfAfter;
        annualChart.update();
            wealthChart.data.labels = labels;
            // Compute cumulative net worth after living costs using free cash flow
            // after living (fcfAfter). This ensures CNW reflects discretionary cash
            // flow rather than total net income. We accumulate the fcfAfter array
            // with investment growth (config.investment_return) to derive CNW
            // after living costs, and deflate it for the real € series.
            const cnwAfter = [];
            let acc2 = 0;
            for (let i = 0; i < fcfAfter.length; i++) {
              acc2 = (acc2 + fcfAfter[i]) * (1 + config.investment_return);
              cnwAfter.push(acc2);
            }
            wealthChart.data.datasets[0].data = cnwAfter;
            wealthwealthChart.data.datasets[1].data = cnwAfter.map((v, i) => v / Math.pow(1 + config.inflation_cpi, i));
            // Update labels to reflect that CNW now accounts for living costs
            wealthChart.data.datasets[0].label = 'CNW after living';
            wealthChart.data.datasets[1].label = 'CNW after living (real €)';
            wealthChart.update();
        // update mix chart highlighting selected specialty
        if (mixChart) {
          mixChart.data.datasets[0].backgroundColor = specialties.map(s => s.key === state.specialtyKey ? '#007bff' : '#6c757d');
          mixChart.update();
        }
        updateSnapshots(spec, series);
        renderSummary(spec);
        renderJobCards();
        updateComparison();
      }
      // Main initialization
      function init() {
        populateSpecialties();
        setupControls();
        const annualCtx = document.getElementById('annualChart').getContext('2d');
        const wealthCtx = document.getElementById('wealthChart').getContext('2d');
        annualChart = new Chart(annualCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Net Income', data: [], borderColor: '#007bff', borderWidth: 2 },
              { label: 'Free Cash Flow', data: [], borderColor: '#28a745', borderWidth: 2 },
              { label: 'Living Costs', data: [], borderColor: '#dc3545', borderWidth: 2, borderDash: [4,4] },
              { label: 'FCF after Living', data: [], borderColor: '#ffc107', borderWidth: 2, borderDash: [2,2] }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { ticks: { callback: v => fmtEuro(v) } } }
          }
        });
        wealthChart = new Chart(wealthCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'CNW', data: [], borderColor: '#007bff', borderWidth: 2 },
              { label: 'CNW (real €)', data: [], borderColor: '#6c757d', borderDash: [5,5], borderWidth: 2 }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { ticks: { callback: v => fmtEuro(v) } } }
          }
        });
        // Initialize mix chart (doctors per specialty)
        const mixCtx = document.getElementById('mixChart').getContext('2d');
        mixChart = new Chart(mixCtx, {
          type: 'bar',
          data: {
            labels: specialties.map(s => s.name),
            datasets: [{
              label: '# Doctors',
              data: specialties.map(s => s.doctors_est),
              backgroundColor: specialties.map(s => s.key === state.specialtyKey ? '#007bff' : '#6c757d')
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
        // Populate job specialty dropdown
        populateJobSpecialties();
        // Render tables: market cap, hospitals and ranking
        renderMarketCap();
        renderHospitals();
        renderRanking();

        // Render initial comparison chart
        updateComparison();

        window.updateAll = updateCharts;
        updateCharts();
      }
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
